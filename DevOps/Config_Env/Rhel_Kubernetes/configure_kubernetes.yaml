---    
  name: Kubernetes Cluster Setup on Rhel9
  hosts: Cluster
  tasks:

  - name: Load variables from vault
    ansible.builtin.include_vars: vault.yml

  - name: Registering Rhel Servers
    ansible.builtin.shell: |
      subscription-manager register --username el-xander --password {{ server_password }} --auto-attach && subscription-manager attach --auto
      
  - name: Update System
    ansible.builtin.yum:
      name: '*'
      state: latest

  - name: Adding mappings to /etc/hosts
    ansible.builtin.blockinfile:
      path: /etc/hosts
      block: |
        {{item.ip}} {{item.name}}
      marker: "#{mark} ANSIBLE MANAGED BLOCK {{item.name}}"
    loop:
    - { name: Kubernetes_Master, ip: 10.0.6.48}
    - { name: Kubernetes_Worker1, ip: 10.0.4.145}
    - { name: Kubernetes_Worker2, ip: 10.0.5.37}

  - name: Installing Kernel Headers
    ansible.builtin.shell: dnf install kernel-devel-$(uname -r)

  - name: Adding Kernel Modules
    ansible.builtin.command: modprobe br_netfilter && modprobe ip_vs && modprobe ip_vs_rr && modprobe ip_vs_wrr && modprobe ip_vs_sh && modprobe overlay

  - name: Creating kubernetes.conf file
    ansible.builtin.file:
      path: /etc/modules-load.d/kubernetes.conf
      state: touch

  - name: Adding modules to kubernetes.conf file
    ansible.builtin.blockinfile:
      path: /etc/modules-load.d/kubernetes.conf
      block: |
        br_netfilter
        ip_vs
        ip_vs_rr
        ip_vs_wrr
        ip_vs_sh
        overlay

  - name: Configuring Sysctl for Kubernetes
    ansible.builtin.file:
      path: /etc/sysctl.d/kubernetes.conf
      state: touch

  - name: Adding system kernel parameters to the "/etc/sysctl.d/kubernetes.conf" file
    ansible.builtin.blockinfile:
    block: |
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1

  - name: Applying Configuration
    ansible.builtin.shell: sysctl --system

  - name: Disabling Swap
    ansible.builtin.command: sudo swapoff -a && sed -e '/swap/s/^/#/g' -i /etc/fstab

  - name: Adding Docker CE Repository
    ansible.builtin.yum_repository:
      name: docker-ce
      description: Docker Repository
      baseurl: https://download.docker.com/linux/centos/docker-ce.repo

  - name: Updating Package Cache
    ansible.builtin.command: dnf makecache

  - name: Installing "Containerd.io" Package
    ansible.builtin.dnf:
      name: containerd.io 
      state: present

  - name: Configuring containerd
    ansible.builtin.shell: sh -c "containerd config default > /etc/containerd/config.toml" 

  - name: Enabling "SystemdCgroup"
    ansible.builtin.replace:
      path: /etc/containerd/config.toml"
      regexp: '^SystemdCgroup = false$'
      replace: 'SystemdCgroup = true'

  - name: Starting and Enabling Conatainerd Service
    ansible.builtin.service:
      name: containerd
      state: started
      enabled: yes

  - name: Reboot Machine
    ansible.builtin.reboot:

  - name: Reconnecting Ansible after reboot
    ansible.builtin.wait_for_connection:
    delay: 60
    timeout: 600

  - name: Checking the status of containerd
    ansible.builtin.shell: systemctl status containerd

  - name: Adding Kubernetes Repository
    ansible.builtin.blockinfile:
      block: |
        [kubernetes]
        name=Kubernetes
        baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
        enabled=1
        gpgcheck=1
        gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
        exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni

  - name: Install Kubernetes packages
    dnf:
      name: "{{ item }}"
      state: present
      disable_excludes: "kubernetes"
    loop:
      - kubelet
      - kubeadm
      - kubectl

  - name: Starting and Enabling Kubelet Service
    ansible.builtin.service:
      name: kubelet
      state: started
      enabled: yes
      
